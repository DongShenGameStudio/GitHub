<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>GitHub ç®€çº¦å¹³å° - 1.9ç‰ˆæœ¬</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--bg:linear-gradient(135deg,#1d2b64 0%,#f8cdda 100%);--card:rgba(255,255,255,0.08);--blur:blur(12px);--neon:#00f2fe;--red:#ff4d4d;--green:#4CAF50;--orange:#FF9800}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,Arial,"PingFang SC","Microsoft YaHei",sans-serif;display:flex;height:100vh;color:#fff;background:var(--bg)}
#left{width:30%;backdrop-filter:var(--blur);background:var(--card);border-right:1px solid rgba(255,255,255,0.15);display:flex;flex-direction:column;padding-left:52px}
#right{flex:1;backdrop-filter:var(--blur);background:var(--card);display:flex;flex-direction:column}
#tree{flex:1;overflow:auto;padding:8px}.item{cursor:pointer;padding:4px 6px;border-radius:4px;transition:background 0.2s}.item:hover{background:rgba(0,242,254,0.15)}
.folder::before{content:"ğŸ“‚ "}.file::before{content:"ğŸ“ "}.repo::before{content:"ğŸ“ "}
.file-size{font-size:10px;color:rgba(255,255,255,0.6);margin-left:8px}
#log{height:120px;border-top:1px solid rgba(255,255,255,0.15);font-size:12px;overflow-y:auto;padding:4px;background:rgba(0,0,0,0.15)}
#viewPre{flex:1;margin:0;padding:12px;background:rgba(0,0,0,0.2);overflow:auto;border-radius:6px}
#editor{width:100%;height:100%;display:none;font-family:monospace;background:rgba(0,0,0,0.25);color:#fff;border:none;padding:12px;outline:none;border-radius:6px}
.bar{padding:8px;display:flex;align-items:center;gap:6px;border-bottom:1px solid rgba(255,255,255,0.15)}
button{background:var(--neon);color:#000;border:none;padding:6px 12px;border-radius:4px;font-weight:bold;cursor:pointer;transition:opacity .2s}
button:hover{opacity:.8}
#crtPath{flex:1}
#beijingTime{margin-left:auto;font-size:14px}
#apiDiag{margin-left:8px;font-size:14px;cursor:pointer;color:var(--neon)}
.token.keyword{color:#ff79c6}
.token.string{color:#f1fa8c}
.token.comment{color:#6272a4}
.token.number{color:#bd93f9}
.token.function{color:#50fa7b}
.token.tag{color:#ff79c6}
.token.attr-name{color:#50fa7b}
.token.attr-value{color:#f1fa8c}
.token.selector{color:#50fa7b}
.token.property{color:#66d9ef}
.token.punctuation{color:#f8f8f2}
.api-status{padding:4px 8px;border-radius:4px;margin:2px;font-size:12px;display:flex;align-items:center;gap:6px}
.api-status.unknown{background:rgba(255,255,255,0.1)}
.api-status.checking{background:rgba(255,193,7,0.2)}
.api-status.success{background:rgba(76,175,80,0.3)}
.api-status.failed{background:rgba(244,67,54,0.3)}
.api-status-list{display:flex;flex-direction:column;gap:4px;margin-top:8px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal-content{background:#1e1e1e;padding:20px;border-radius:8px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.modal-title{font-size:18px;font-weight:bold}
.modal-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer}
.secret-list{display:flex;flex-direction:column;gap:8px;margin:15px 0}
.secret-item{padding:10px;background:rgba(255,255,255,0.1);border-radius:4px;cursor:pointer;transition:background 0.2s}
.secret-item:hover{background:rgba(255,255,255,0.2)}
.secret-item.active{background:rgba(0,242,254,0.3)}
.secret-info{font-size:14px}
.secret-time{font-size:12px;color:rgba(255,255,255,0.7)}
.upload-modal{max-width:600px;}
.upload-area{border:2px dashed rgba(255,255,255,0.3);border-radius:8px;padding:30px;text-align:center;margin:15px 0;cursor:pointer;transition:all 0.3s}
.upload-area:hover{background:rgba(255,255,255,0.1);border-color:var(--neon)}
.upload-area.highlight{background:rgba(0,242,254,0.1);border-color:var(--neon)}
.file-list{margin-top:15px;max-height:200px;overflow-y:auto}
.file-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;margin-bottom:5px}
.file-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.upload-file-size{color:rgba(255,255,255,0.7);margin:0 10px}
.remove-file{background:var(--red);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.path-input{margin-top:15px}
.path-input input{width:100%;padding:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:4px;color:white}
.path-input label{display:block;margin-bottom:5px;font-size:14px}
.deploy-result{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e1e1e;padding:20px;border-radius:8px;max-width:500px;width:90%;z-index:1001;box-shadow:0 10px 30px rgba(0,0,0,0.5);display:none}
.deploy-url{display:flex;align-items:center;gap:10px;margin-top:10px}
.deploy-url input{flex:1;padding:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:4px;color:white}
.deploy-url button{background:var(--green);white-space:nowrap}
@media (max-width: 768px) {
  body { flex-direction:column; }
  #left { width:100%; height:auto; max-height:45vh; border-right:none; border-bottom:1px solid rgba(255,255,255,0.15); padding-left:8px; }
  #right { width:100%; flex:1; }
  .bar { flex-wrap:wrap; gap:4px; }
  button { font-size:16px; }
  #tree { max-height:30vh; }
  #log { max-height:15vh; }
  #viewPre, #editor { font-size:14px; padding:8px; }
}
</style>
</head>
<body>

<div id="left">
  <div class="bar">
    <button onclick="showSecretModal()">å¯†é’¥åˆ‡æ¢</button>
    <button onclick="createRepo()">æ–°å»ºä»“åº“</button>
    <button onclick="deleteRepo()">åˆ é™¤ä»“åº“</button>
    <button id="uploadBtn" style="display:none" onclick="showUploadModal()">ä¸Šä¼ æ–‡ä»¶</button>
    <span id="secretStat" style="margin-left:auto"></span>
    <span id="beijingTime" style="margin-left:16px;font-size:14px"></span>
    <span id="apiDiag" style="margin-left:8px;font-size:14px;cursor:pointer;color:var(--neon)" onclick="checkAllAPIs()">API è¯Šæ–­</span>
  </div>
  <div id="tree">æ­£åœ¨å°è¯•è¿æ¥æœåŠ¡å™¨ä¸­â€¦</div>
  <div id="log"></div>
</div>

<div id="right">
  <div class="bar">
    <span id="crtPath">æœªé€‰æ‹©æ–‡ä»¶</span>
    <button id="editBtn" onclick="toggleEdit()">ç¼–è¾‘</button>
    <button id="saveBtn" style="display:none" onclick="saveFile()">ä¿å­˜</button>
    <button id="downloadBtn" style="display:none" onclick="downloadFile()">ä¸‹è½½</button>
    <button id="deleteFileBtn" style="display:none" onclick="deleteFile()">åˆ é™¤æ–‡ä»¶</button>
    <button id="deployBtn" style="display:none" onclick="deployRepo()">éƒ¨ç½²</button>
  </div>
  <pre id="viewPre"></pre>
  <textarea id="editor"></textarea>
</div>

<!-- éƒ¨ç½²ç»“æœæ˜¾ç¤ºæ¡† -->
<div id="deployResult" class="deploy-result"></div>

<!-- å¯†é’¥åˆ‡æ¢æ¨¡æ€æ¡† -->
<div id="secretModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">å¯†é’¥ç®¡ç†</div>
      <button class="modal-close" onclick="hideSecretModal()">Ã—</button>
    </div>
    <div class="secret-list" id="secretList">
      <!-- å¯†é’¥åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:15px">
      <button onclick="addNewSecret()">æ·»åŠ æ–°å¯†é’¥</button>
      <button onclick="hideSecretModal()">å…³é—­</button>
    </div>
  </div>
</div>

<!-- APIè¯Šæ–­æ¨¡æ€æ¡† -->
<div id="apiModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">API è¯Šæ–­</div>
      <button class="modal-close" onclick="hideApiModal()">Ã—</button>
    </div>
    <div class="api-status-list" id="apiStatusList">
      <div class="api-status unknown" id="timeAPI1">
        <span>â—¯</span>
        <span>æ—¶é—´API 1</span>
      </div>
      <div class="api-status unknown" id="timeAPI2">
        <span>â—¯</span>
        <span>æ—¶é—´API 2</span>
      </div>
      <div class="api-status unknown" id="timeAPI3">
        <span>â—¯</span>
        <span>æ—¶é—´API 3</span>
      </div>
      <div class="api-status unknown" id="timeAPI4">
        <span>â—¯</span>
        <span>æ—¶é—´API 4</span>
      </div>
      <div class="api-status unknown" id="timeAPI5">
        <span>â—¯</span>
        <span>æ—¶é—´API 5</span>
      </div>
      <div class="api-status unknown" id="timeAPI6">
        <span>â—¯</span>
        <span>æ—¶é—´API 6</span>
      </div>
      <div class="api-status unknown" id="githubAPI">
        <span>â—¯</span>
        <span>GitHub API</span>
      </div>
      <div class="api-status unknown" id="indexedDB">
        <span>â—¯</span>
        <span>IndexedDB</span>
      </div>
      <div class="api-status unknown" id="codeHighlight">
        <span>â—¯</span>
        <span>ä»£ç é«˜äº®</span>
      </div>
      <div class="api-status unknown" id="logDisplay">
        <span>â—¯</span>
        <span>æ—¥å¿—æ˜¾ç¤º</span>
      </div>
      <div class="api-status unknown" id="buttonClick">
        <span>â—¯</span>
        <span>æŒ‰é’®ç‚¹å‡»</span>
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:15px">
      <button onclick="hideApiModal()">å…³é—­</button>
    </div>
  </div>
</div>

<!-- ä¸Šä¼ æ–‡ä»¶æ¨¡æ€æ¡† -->
<div id="uploadModal" class="modal" style="display:none">
  <div class="modal-content upload-modal">
    <div class="modal-header">
      <div class="modal-title" id="uploadModalTitle">ä¸Šä¼ æ–‡ä»¶åˆ°ä»“åº“</div>
      <button class="modal-close" onclick="hideUploadModal()">Ã—</button>
    </div>
    <div id="uploadArea" class="upload-area">
      <div>ğŸ“ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</div>
      <div style="font-size:12px;margin-top:8px;color:rgba(255,255,255,0.7)">æ”¯æŒå•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ä¸Šä¼ </div>
    </div>
    <input type="file" id="fileInput" multiple style="display:none">
    <div class="file-list" id="fileList">
      <!-- æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div class="path-input">
      <label for="uploadPath">æ–‡ä»¶åœ¨ä»“åº“ä¸­çš„è·¯å¾„:</label>
      <input type="text" id="uploadPath" placeholder="ä¾‹å¦‚: src/myfile.js (ç•™ç©ºåˆ™ä½¿ç”¨åŸæ–‡ä»¶å)">
    </div>
    <div style="display:flex;justify-content:space-between;margin-top:15px">
      <button onclick="uploadFiles()">ä¸Šä¼ æ–‡ä»¶</button>
      <button onclick="hideUploadModal()">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
/* ========== è¿·ä½ å†…ç½®é«˜äº®ï¼ˆä¸æ±¡æŸ“å…¨å±€ï¼‰ ========== */
function highlightCode(text,lang){
  const tokenMap={
    javascript:/\b(?:as|async|await|break|case|catch|class|const|continue|debugger|default|delete|do|else|enum|export|extends|finally|for|from|function|get|if|implements|import|in|instanceof|interface|let|new|null|of|package|private|protected|public|return|set|static|super|switch|this|throw|try|typeof|var|void|while|with|yield)\b/g,
    python:/\b(?:and|as|assert|break|class|continue|def|del|elif|else|except|exec|finally|for|from|global|if|import|in|is|lambda|not|or|pass|print|raise|return|try|while|with|yield|as|async|await|nonlocal)\b/g,
    css:/\b(?:@media|@import|@charset|@keyframes|color|background|border|margin|padding|font|display|position|width|height|top|left|right|bottom|z-index|opacity|transition|transform|animation)\b/g,
    html:/\b(?:html|head|body|div|span|a|p|img|ul|ol|li|table|tr|td|th|form|input|button|select|textarea|script|style|link|meta|title|h[1-6]|br|hr)\b/g,
    common:/\b(?:true|false|null|function|return|if|else|for|while|do|break|continue|try|catch|finally|throw|new|var|let|const|typeof|instanceof)\b/g
  };
  const ext=(lang||'').toLowerCase().split('.').pop();
  const pat=tokenMap[ext]||tokenMap.common;
  
  // é’ˆå¯¹ä¸åŒè¯­è¨€çš„ç‰¹å®šé«˜äº®è§„åˆ™
  let highlighted = text;
  
  // HTMLæ ‡ç­¾é«˜äº®
  if (ext === 'html') {
    highlighted = highlighted.replace(/&lt;(\/?)([a-zA-Z][a-zA-Z0-9-]*)/g, '&lt;$1<span class="token tag">$2</span>');
    highlighted = highlighted.replace(/([a-zA-Z-]+)=/g, '<span class="token attr-name">$1</span>=');
    highlighted = highlighted.replace(/="([^"]*)"/g, '="<span class="token attr-value">$1</span>"');
  }
  
  // CSSå±æ€§é«˜äº®
  if (ext === 'css') {
    highlighted = highlighted.replace(/([a-zA-Z-]+)\s*:/g, '<span class="token property">$1</span>:');
    highlighted = highlighted.replace(/#([a-fA-F0-9]{3,6})/g, '<span class="token string">#$1</span>');
  }
  
  // JavaScriptå‡½æ•°é«˜äº®
  if (ext === 'javascript') {
    highlighted = highlighted.replace(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*\(/g, '<span class="token function">$1</span>(');
  }
  
  // é€šç”¨é«˜äº®è§„åˆ™
  highlighted = highlighted.replace(pat,'<span class="token keyword">$&</span>')
             .replace(/(["'])(?:\\[\s\S]|(?!\1)[^\\])*\1/g,'<span class="token string">$&</span>')
             .replace(/\/\/.*$/gm,'<span class="token comment">$&</span>')
             .replace(/\/\*[\s\S]*?\*\//g,'<span class="token comment">$&</span>')
             .replace(/\b\d+\.?\d*(?:e[+-]?\d+)?\b/g,'<span class="token number">$&</span>');
  
  return highlighted;
}

/* ========== åŸºç¡€å·¥å…· ========== */
const DB_NAME = 'github_studio';
const STORE = {secret:'secret', log:'log', snap:'snap', cache:'cache'};
let secret, selected={repo:'',path:'',sha:'',downloadUrl:''}, currentRepo='';
let selectedFiles = [];
let currentUser = null;
let deployedRepos = new Set(); // å­˜å‚¨å·²éƒ¨ç½²çš„ä»“åº“
let currentDeployTimeout = null; // å­˜å‚¨å½“å‰çš„éƒ¨ç½²ç»“æœè¶…æ—¶

async function openDB(){
  return new Promise((resolve,reject)=>{
    const r = indexedDB.open(DB_NAME,3); // ç‰ˆæœ¬å‡çº§åˆ°3
    r.onupgradeneeded=(e)=>{
      const db=e.target.result; 
      for(const k of Object.values(STORE)){
        if(!db.objectStoreNames.contains(k)) db.createObjectStore(k); 
      }
    };
    r.onsuccess=()=>resolve(r.result);
    r.onerror=()=>reject(r.error);
  });
}

async function dbPut(s,k,v){ 
  const db=await openDB();
  const tx=db.transaction(s,'readwrite'); 
  return new Promise((resolve,reject)=>{
    const req = tx.objectStore(s).put(v,k);
    req.onsuccess=()=>resolve();
    req.onerror=()=>reject(req.error);
  });
}

async function dbGet(s,k){ 
  const db=await openDB();
  const tx=db.transaction(s);
  const r=tx.objectStore(s).get(k); 
  return new Promise(res=>{
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>res(null);
  });
}

async function dbGetAll(s){ 
  const db=await openDB();
  const tx=db.transaction(s);
  const r=tx.objectStore(s).getAll(); 
  return new Promise(res=>{
    r.onsuccess=()=>res(r.result);
    r.onerror=()=>res([]);
  });
}

async function dbDel(s,k){ 
  const db=await openDB();
  const tx=db.transaction(s,'readwrite'); 
  return new Promise((resolve,reject)=>{
    const req = tx.objectStore(s).delete(k);
    req.onsuccess=()=>resolve();
    req.onerror=()=>reject(req.error);
  });
}

/* ========== å…­ç»„åŒ—äº¬æ—¶é—´ API æ±  ========== */
const TIME_APIS = [
  'https://worldtimeapi.org/api/timezone/Asia/Shanghai',
  'https://timeapi.io/api/Time/current/zone?timeZone=Asia%2FShanghai',
  'https://worldclockapi.com/api/json/est/now',
  'http://worldclockapi.com/api/json/cst/now',
  'https://www.timeapi.io/api/Time/current/zone?timeZone=Asia/Shanghai',
  'https://worldtimeapi.org/api/ip'
];

async function getTime(){
  // é¦–å…ˆå°è¯•ä½¿ç”¨æœ¬åœ°å­˜å‚¨çš„æ—¶é—´ï¼Œé¿å…é¢‘ç¹è¯·æ±‚API
  const cachedTime = localStorage.getItem('cachedTime');
  const cachedTimeStamp = localStorage.getItem('cachedTimeStamp');
  
  if (cachedTime && cachedTimeStamp) {
    const now = Date.now();
    const cacheAge = now - parseInt(cachedTimeStamp);
    // å¦‚æœç¼“å­˜æ—¶é—´åœ¨5åˆ†é’Ÿå†…ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜
    if (cacheAge < 5 * 60 * 1000) {
      return new Date(parseInt(cachedTime));
    }
  }
  
  for (let url of TIME_APIS) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000);
      
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeoutId);
      
      if (!res.ok) continue;
      const j = await res.json();
      const iso = j.datetime || j.currentDateTime || j.dateTime || j.utc_datetime;
      if (!iso) continue;
      
      const date = new Date(iso);
      
      // ç¼“å­˜æ—¶é—´
      localStorage.setItem('cachedTime', date.getTime().toString());
      localStorage.setItem('cachedTimeStamp', Date.now().toString());
      
      return date;
    } catch (e) {
      console.warn('æ—¶é—´APIå¤±è´¥', url, e);
      continue;
    }
  }
  
  console.warn('å…¨éƒ¨æ—¶é—´APIå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´+8å°æ—¶ä¿åº•');
  const localTime = new Date(Date.now() + 8 * 3600 * 1000);
  
  // ç¼“å­˜æœ¬åœ°æ—¶é—´
  localStorage.setItem('cachedTime', localTime.getTime().toString());
  localStorage.setItem('cachedTimeStamp', Date.now().toString());
  
  return localTime;
}

/* ====== åŒ—äº¬æ—¶é—´æ—¶é’Ÿ ====== */
async function updateClock(){
  try {
    const t = await getTime();
    document.getElementById('beijingTime').textContent = 'åŒ—äº¬æ—¶é—´ï¼š' + t.toLocaleString('zh-CN');
  } catch(e) {
    console.error('æ›´æ–°æ—¶é—´å¤±è´¥:', e);
    // ä½¿ç”¨æœ¬åœ°æ—¶é—´ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
    const localTime = new Date(Date.now() + 8 * 3600 * 1000);
    document.getElementById('beijingTime').textContent = 'åŒ—äº¬æ—¶é—´ï¼š' + localTime.toLocaleString('zh-CN');
  }
}
// æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´ï¼Œç¡®ä¿ç§’æ•°æ­£å¸¸æ›´æ–°
setInterval(updateClock, 1000);
updateClock();

function b64e(str){ return btoa(unescape(encodeURIComponent(str))) }
function b64d(b64){ return decodeURIComponent(escape(atob(b64))) }

/* ====== è·å–ç”¨æˆ·ä¿¡æ¯ ====== */
async function getUserInfo() {
  if (!secret) return null;
  
  try {
    const userInfo = await apiCall('https://api.github.com/user');
    if (userInfo && userInfo.login) {
      currentUser = userInfo;
      return userInfo;
    }
  } catch (e) {
    console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
  }
  return null;
}

/* ====== æ£€æµ‹ä»“åº“éƒ¨ç½²çŠ¶æ€ ====== */
async function checkRepoDeployment(repo) {
  try {
    const pagesInfo = await apiCall(`https://api.github.com/repos/${repo}/pages`);
    if (pagesInfo && pagesInfo.status === 'built') {
      deployedRepos.add(repo);
      return true;
    }
  } catch (e) {
    // å¦‚æœAPIè¿”å›404æˆ–å…¶ä»–é”™è¯¯ï¼Œè¯´æ˜æœªéƒ¨ç½²
    deployedRepos.delete(repo);
  }
  return false;
}

/* ====== æ›´æ–°éƒ¨ç½²æŒ‰é’®çŠ¶æ€ ====== */
async function updateDeployButton(repo) {
  const deployBtn = document.getElementById('deployBtn');
  if (!deployBtn) return;
  
  const isDeployed = await checkRepoDeployment(repo);
  
  if (isDeployed) {
    deployBtn.textContent = 'å–æ¶ˆéƒ¨ç½²';
    deployBtn.style.background = 'var(--red)';
    deployBtn.onclick = () => undeployRepo(repo);
  } else {
    deployBtn.textContent = 'éƒ¨ç½²';
    deployBtn.style.background = 'var(--neon)';
    deployBtn.onclick = () => deployRepo(repo);
  }
}

/* ====== å¯†é’¥ç®¡ç† ====== */
async function checkSecret(){
  try {
    const secrets = await dbGetAll(STORE.secret);
    if (!secrets || secrets.length === 0) {
      // æ²¡æœ‰å¯†é’¥ï¼Œæç¤ºç”¨æˆ·è¾“å…¥
      const stat = document.getElementById('secretStat');
      stat.textContent = 'æ‚¨å°šæœªå¢åŠ å¯†é’¥';
      stat.style.color = '#fff';
      
      if (!localStorage.getItem('firstTimePrompted')) {
        localStorage.setItem('firstTimePrompted', 'true');
        setTimeout(() => {
          saveSecret();
        }, 1000);
      }
      return null;
    }
    
    // è·å–å½“å‰ä½¿ç”¨çš„å¯†é’¥
    const currentSecretId = localStorage.getItem('currentSecretId');
    let currentSecret = null;
    
    if (currentSecretId) {
      currentSecret = secrets.find(s => s.id === currentSecretId);
    }
    
    // å¦‚æœæ²¡æœ‰å½“å‰å¯†é’¥æˆ–å½“å‰å¯†é’¥å·²è¿‡æœŸï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæœªè¿‡æœŸçš„å¯†é’¥
    if (!currentSecret) {
      const now = await getTime();
      currentSecret = secrets.find(s => {
        const expire = new Date(s.expireAt);
        return expire > now;
      });
      
      if (currentSecret) {
        localStorage.setItem('currentSecretId', currentSecret.id);
      }
    }
    
    // æ£€æŸ¥å½“å‰å¯†é’¥æ˜¯å¦è¿‡æœŸ
    if (currentSecret) {
      const now = await getTime();
      const expire = new Date(currentSecret.expireAt);
      const days = Math.max(0, (expire - now) / 864e5);
      
      const stat = document.getElementById('secretStat');
      if (days <= 0) {
        stat.textContent = 'å¯†é’¥å·²åˆ°æœŸ';
        stat.style.color = 'var(--red)';
        
        // å¯†é’¥åˆ°æœŸæç¤º
        if (!localStorage.getItem(`expiredPrompted_${currentSecret.id}`)) {
          localStorage.setItem(`expiredPrompted_${currentSecret.id}`, 'true');
          setTimeout(() => {
            alert('å½“å‰å¯†é’¥å·²åˆ°æœŸï¼Œè¯·åˆ‡æ¢æˆ–æ·»åŠ æ–°å¯†é’¥');
            showSecretModal();
          }, 1000);
        }
        
        return null;
      } else {
        stat.style.color = days <= 3 ? 'var(--red)' : '#fff';
        stat.textContent = `åˆ°æœŸï¼š${expire.toLocaleDateString('zh-CN')} (å‰©ä½™${Math.floor(days)}å¤©)`;
        secret = currentSecret.secret;
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        await getUserInfo();
        return secret;
      }
    } else {
      // æ‰€æœ‰å¯†é’¥éƒ½å·²è¿‡æœŸ
      const stat = document.getElementById('secretStat');
      stat.textContent = 'æ‰€æœ‰å¯†é’¥å·²åˆ°æœŸ';
      stat.style.color = 'var(--red)';
      
      if (!localStorage.getItem('allExpiredPrompted')) {
        localStorage.setItem('allExpiredPrompted', 'true');
        setTimeout(() => {
          alert('æ‰€æœ‰å¯†é’¥å·²åˆ°æœŸï¼Œè¯·æ·»åŠ æ–°å¯†é’¥');
          saveSecret();
        }, 1000);
      }
      
      return null;
    }
  } catch(e) {
    console.error('æ£€æŸ¥å¯†é’¥å¤±è´¥:', e);
    const stat = document.getElementById('secretStat');
    stat.textContent = 'å¯†é’¥æ£€æŸ¥å¤±è´¥';
    stat.style.color = 'var(--red)';
    return null;
  }
}

async function saveSecret(){
  const s = prompt('è¾“å…¥"ä¸œç¥å¼€æ”¾å¹³å°"å¯†é’¥'); 
  if(!s) return;
  
  if(!/^(ghp_|github_pat_[a-zA-Z0-9_]{36,251})$/.test(s))   
    return alert('æ ¼å¼é”™è¯¯ï¼\nè¯·å¤åˆ¶ Classic (dongshenteam) æˆ– Fine-grained (donggodteam_pat_) å®Œæ•´å¯†é’¥');
  
  const t = await getTime();
  const expire = new Date(t.getTime() + 7 * 24 * 60 * 60 * 1000);
  const id = `secret_${Date.now()}`;
  
  const secretData = {
    id: id,
    secret: s,
    addedAt: t.toISOString(),
    savedAt: t.toISOString(),
    expireAt: expire.toISOString()
  };
  
  await dbPut(STORE.secret, id, secretData);
  localStorage.setItem('currentSecretId', id);
  await checkSecret();
  await loadRepoList();
  await renderSecretList();
  
  // è®°å½•ä¿å­˜å¯†é’¥çš„æ—¥å¿—
  const userInfo = await getUserInfo();
  const maskedSecret = s.substring(0, 8) + '...' + s.substring(s.length - 4);
  const userName = userInfo ? userInfo.login : 'æœªçŸ¥ç”¨æˆ·';
  await log('save-secret', '', '', `ä¿å­˜å¯†é’¥ ${maskedSecret} (ç”¨æˆ·: ${userName})`);
}

async function switchSecret(secretId) {
  const secretData = await dbGet(STORE.secret, secretId);
  if (!secretData) return;
  
  const t = await getTime();
  const expire = new Date(t.getTime() + 7 * 24 * 60 * 60 * 1000);
  
  // æ›´æ–°ä¿å­˜æ—¶é—´å’Œè¿‡æœŸæ—¶é—´
  secretData.savedAt = t.toISOString();
  secretData.expireAt = expire.toISOString();
  
  await dbPut(STORE.secret, secretId, secretData);
  localStorage.setItem('currentSecretId', secretId);
  await checkSecret();
  await loadRepoList();
  
  // è®°å½•åˆ‡æ¢å¯†é’¥çš„æ—¥å¿—
  const userInfo = await getUserInfo();
  const maskedSecret = secretData.secret.substring(0, 8) + '...' + secretData.secret.substring(secretData.secret.length - 4);
  const userName = userInfo ? userInfo.login : 'æœªçŸ¥ç”¨æˆ·';
  await log('switch-secret', '', '', `åˆ‡æ¢åˆ°å¯†é’¥ ${maskedSecret} (ç”¨æˆ·: ${userName})`);
  
  hideSecretModal();
}

async function addNewSecret() {
  await saveSecret();
}

function showSecretModal() {
  renderSecretList();
  document.getElementById('secretModal').style.display = 'flex';
}

function hideSecretModal() {
  document.getElementById('secretModal').style.display = 'none';
}

async function renderSecretList() {
  const secrets = await dbGetAll(STORE.secret);
  const currentSecretId = localStorage.getItem('currentSecretId');
  const secretList = document.getElementById('secretList');
  
  secretList.innerHTML = '';
  
  if (secrets.length === 0) {
    secretList.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.7)">æš‚æ— å¯†é’¥</div>';
    return;
  }
  
  secrets.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
  
  secrets.forEach(secret => {
    const addedTime = new Date(secret.addedAt);
    const expireTime = new Date(secret.expireAt);
    const now = new Date();
    const isExpired = expireTime < now;
    const isCurrent = secret.id === currentSecretId;
    
    const secretItem = document.createElement('div');
    secretItem.className = `secret-item ${isCurrent ? 'active' : ''} ${isExpired ? 'expired' : ''}`;
    secretItem.onclick = () => switchSecret(secret.id);
    
    const maskedSecret = secret.secret.substring(0, 10) + '...' + secret.secret.substring(secret.secret.length - 4);
    
    secretItem.innerHTML = `
      <div class="secret-info">${maskedSecret}</div>
      <div class="secret-time">æ·»åŠ æ—¶é—´: ${addedTime.toLocaleString('zh-CN')}</div>
      <div class="secret-time">è¿‡æœŸæ—¶é—´: ${expireTime.toLocaleDateString('zh-CN')} ${isExpired ? '(å·²è¿‡æœŸ)' : ''}</div>
    `;
    
    secretList.appendChild(secretItem);
  });
}

/* ====== æ—¥å¿— ====== */
async function log(action,repo,path='',msg=''){
  try {
    const t = await getTime(), id = Date.now();
    const actionCN = {
      'list-repos':'åˆ—å‡ºä»“åº“',
      'open-repo':'æ‰“å¼€ä»“åº“',
      'open-file':'æ‰“å¼€æ–‡ä»¶',
      'update-file':'æ›´æ–°æ–‡ä»¶',
      'delete-file':'åˆ é™¤æ–‡ä»¶',
      'create-repo':'åˆ›å»ºä»“åº“',
      'delete-repo':'åˆ é™¤ä»“åº“',
      'upload-file':'ä¸Šä¼ æ–‡ä»¶',
      'download-file':'ä¸‹è½½æ–‡ä»¶',
      'deploy-repo':'éƒ¨ç½²ä»“åº“',
      'undeploy-repo':'å–æ¶ˆéƒ¨ç½²',
      'toggle-edit':'åˆ‡æ¢ç¼–è¾‘æ¨¡å¼',
      'save-secret':'ä¿å­˜å¯†é’¥',
      'switch-secret':'åˆ‡æ¢å¯†é’¥'
    };
    await dbPut(STORE.log, id, {id, time:t.toLocaleString('zh-CN'), action:actionCN[action]||action, repo, path, msg});
    await trimLog(); 
    await renderLog();
  } catch(e) {
    console.error('è®°å½•æ—¥å¿—å¤±è´¥:', e);
  }
}

async function trimLog(){
  try {
    const db = await openDB();
    const tx = db.transaction(STORE.log, 'readonly');
    const store = tx.objectStore(STORE.log);
    const all = await new Promise(resolve => {
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
    });
    all.sort((a,b) => b.id - a.id);
    if(all.length > 91) {
      for(const old of all.slice(91)) {
        await dbDel(STORE.log, old.id);
      }
    }
  } catch(e) {
    console.error('æ¸…ç†æ—¥å¿—å¤±è´¥:', e);
  }
}

async function renderLog(){
  try {
    const db = await openDB();
    const tx = db.transaction(STORE.log, 'readonly');
    const store = tx.objectStore(STORE.log);
    const entries = await new Promise(resolve => {
      const req = store.getAll();
      req.onsuccess = () => resolve(req.result);
    });
    entries.sort((a,b) => b.id - a.id);
    document.getElementById('log').innerHTML = entries.map(e => `<div>${e.time} [${e.action}] ${e.repo}${e.path?':'+e.path:''} ${e.msg||''}</div>`).join('');
  } catch(e) {
    console.error('æ¸²æŸ“æ—¥å¿—å¤±è´¥:', e);
  }
}

/* ====== ä»“åº“åˆ—è¡¨ ====== */
async function loadRepoList(){
  if(!secret) return;
  
  try {
    const repos = await apiCall('https://api.github.com/user/repos?per_page=100');
    if(!repos) return;
    
    const tree = document.getElementById('tree'); 
    tree.innerHTML = '';
    
    if (repos.length === 0) {
      tree.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.7)">æš‚æ— ä»“åº“</div>';
      return;
    }
    
    repos.forEach(r => {
      const div = document.createElement('div'); 
      div.className = 'item repo'; 
      div.textContent = r.full_name;
      div.onclick = () => toggleRepo(r.full_name, r.default_branch);
      tree.appendChild(div);
    });
    
    await log('list-repos', '', '', 'åˆ—å‡ºæ‰€æœ‰ä»“åº“');
  } catch(e) {
    console.error('åŠ è½½ä»“åº“åˆ—è¡¨å¤±è´¥:', e);
    document.getElementById('tree').innerHTML = '<div style="text-align:center;padding:20px;color:var(--red)">åŠ è½½ä»“åº“åˆ—è¡¨å¤±è´¥</div>';
  }
}

async function toggleRepo(repo, branch){
  try {
    selected = {repo:'', path:'', sha:'', downloadUrl:''};
    currentRepo = repo;
    document.getElementById('viewPre').textContent = ''; 
    document.getElementById('editor').style.display = 'none';
    
    const div = Array.from(document.querySelectorAll('.item')).find(d => d.textContent === repo);
    const ex = div.nextElementSibling;
    if(ex && ex.classList.contains('files')){ 
      ex.remove(); 
      document.getElementById('uploadBtn').style.display = 'none'; 
      document.getElementById('deployBtn').style.display = 'none';
      return; 
    }
    
    const files = await apiCall(`https://api.github.com/repos/${repo}/git/trees/${branch}?recursive=1`);
    if(!files) return;
    
    const box = document.createElement('div'); 
    box.className = 'files'; 
    box.style.paddingLeft = '16px';
    
    if (files.tree && files.tree.length > 0) {
      files.tree.filter(f => f.type === 'blob').forEach(f => {
        const d = document.createElement('div'); 
        d.className = 'item file'; 
        d.textContent = f.path;
        
        // æ·»åŠ æ–‡ä»¶å¤§å°ä¿¡æ¯
        const sizeSpan = document.createElement('span');
        sizeSpan.className = 'file-size';
        sizeSpan.textContent = formatFileSize(f.size || 0);
        d.appendChild(sizeSpan);
        
        d.onclick = (e) => { e.stopPropagation(); openFile(repo, f.path, f.sha); };
        box.appendChild(d);
      });
    } else {
      box.innerHTML = '<div style="padding:10px;text-align:center;color:rgba(255,255,255,0.7)">ä»“åº“ä¸ºç©º</div>';
    }
    
    div.after(box);
    document.getElementById('uploadBtn').style.display = 'inline';
    document.getElementById('deployBtn').style.display = 'inline';
    
    // æ›´æ–°éƒ¨ç½²æŒ‰é’®çŠ¶æ€
    await updateDeployButton(repo);
    
    await log('open-repo', repo, '', 'æ‰“å¼€ä»“åº“');
  } catch(e) {
    console.error('åˆ‡æ¢ä»“åº“å¤±è´¥:', e);
  }
}

/* ====== æ–‡ä»¶é¢„è§ˆ / ç¼–è¾‘ / ä¸‹è½½ / åˆ é™¤ ====== */
async function openFile(repo, path, sha){
  try {
    selected = {repo, path, sha, downloadUrl:`https://api.github.com/repos/${repo}/contents/${path}`};
    
    // è·å–æ–‡ä»¶å¤§å°ä¿¡æ¯
    const fileInfo = await apiCall(`https://api.github.com/repos/${repo}/contents/${path}`);
    const fileSize = fileInfo ? fileInfo.size : 0;
    const formattedSize = formatFileSize(fileSize);
    
    document.getElementById('crtPath').textContent = `${repo}:${path} (${formattedSize})`;
    
    const key = repo + path;
    let content = (await dbGet(STORE.cache, key))?.content;
    
    if(!content){
      const f = await apiCall(`https://api.github.com/repos/${repo}/contents/${path}`);
      if(!f) return;
      content = b64d(f.content); 
      await dbPut(STORE.cache, key, {content, updatedAt:Date.now()});
    }
    
    const lang = guessLanguage(path);
    document.getElementById('viewPre').innerHTML = highlightCode(content, lang);
    document.getElementById('viewPre').style.display = 'block';
    document.getElementById('editor').value = content || '';
    document.getElementById('editor').style.display = 'none';
    document.getElementById('editBtn').style.display = 'inline';
    document.getElementById('saveBtn').style.display = 'none';
    document.getElementById('downloadBtn').style.display = 'inline';
    document.getElementById('deleteFileBtn').style.display = 'inline';
    document.getElementById('deployBtn').style.display = 'none';
    
    await log('open-file', repo, path, `æ‰“å¼€æ–‡ä»¶ (${formattedSize})`);
  } catch(e) {
    console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', e);
    document.getElementById('viewPre').textContent = 'æ‰“å¼€æ–‡ä»¶å¤±è´¥: ' + e.message;
  }
}

function guessLanguage(filename){
  const ext = filename.split('.').pop().toLowerCase();
  const map = {
    js:'javascript', ts:'typescript', py:'python', java:'java', c:'c', cpp:'cpp',
    html:'html', css:'css', json:'json', md:'markdown', xml:'xml', sql:'sql',
    sh:'bash', php:'php', rb:'ruby', go:'go', rs:'rust'
  };
  return map[ext] || 'text';
}

/* ====== APIè°ƒç”¨ ====== */
async function apiCall(url, method='GET', body=null){
  if(!secret){ 
    await checkSecret(); 
    if(!secret) return null; 
  }
  try {
    const options = {
      method, 
      headers: {
        'Authorization': `token ${secret}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      }
    };
    if(body) options.body = JSON.stringify(body);
    
    const res = await fetch(url, options);
    if(!res.ok){ 
      if (res.status !== 404 && !url.includes('/pages')) { // 404é”™è¯¯å’Œpages APIçš„é”™è¯¯ä¸å¼¹çª—
        alert('API é”™è¯¯ ' + res.status); 
      }
      return null; 
    }
    return res.json();
  } catch(e) {
    console.error('APIè°ƒç”¨å¤±è´¥:', e);
    if (!url.includes('/pages')) { // pages APIçš„é”™è¯¯ä¸å¼¹çª—
      alert('APIè°ƒç”¨å¤±è´¥: ' + e.message);
    }
    return null;
  }
}

/* ====== æ–‡ä»¶å¤§å°æ ¼å¼åŒ– ====== */
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/* ====== æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ ====== */
function showUploadModal() {
  if (!currentRepo) {
    alert('è¯·å…ˆé€‰æ‹©ä»“åº“');
    return;
  }
  
  // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰ä»“åº“
  document.getElementById('uploadModalTitle').textContent = 'ä¸Šä¼ æ–‡ä»¶åˆ°ä»“åº“: ' + currentRepo;
  
  // é‡ç½®çŠ¶æ€
  selectedFiles = [];
  document.getElementById('fileList').innerHTML = '';
  document.getElementById('uploadPath').value = '';
  document.getElementById('uploadModal').style.display = 'flex';
  
  // è®¾ç½®æ‹–æ”¾äº‹ä»¶
  const uploadArea = document.getElementById('uploadArea');
  
  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('highlight');
  });
  
  uploadArea.addEventListener('dragleave', function() {
    uploadArea.classList.remove('highlight');
  });
  
  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('highlight');
    handleFiles(e.dataTransfer.files);
  });
  
  uploadArea.addEventListener('click', function() {
    document.getElementById('fileInput').click();
  });
  
  // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
  document.getElementById('fileInput').addEventListener('change', function(e) {
    handleFiles(e.target.files);
  });
}

function hideUploadModal() {
  document.getElementById('uploadModal').style.display = 'none';
}

function handleFiles(files) {
  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
    if (selectedFiles.some(f => f.name === file.name)) {
      continue;
    }
    
    // æ·»åŠ åˆ°æ–‡ä»¶åˆ—è¡¨
    selectedFiles.push(file);
    
    // æ›´æ–°UI
    renderFileList();
  }
  
  // é‡ç½®æ–‡ä»¶è¾“å…¥
  document.getElementById('fileInput').value = '';
}

function renderFileList() {
  const fileList = document.getElementById('fileList');
  fileList.innerHTML = '';
  
  if (selectedFiles.length === 0) {
    fileList.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(255,255,255,0.7)">æš‚æ— æ–‡ä»¶</div>';
    return;
  }
  
  selectedFiles.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.className = 'file-item';
    
    const fileSize = formatFileSize(file.size);
    
    fileItem.innerHTML = `
      <div class="file-name">${file.name}</div>
      <div class="upload-file-size">${fileSize}</div>
      <button class="remove-file" onclick="removeFile(${index})">Ã—</button>
    `;
    
    fileList.appendChild(fileItem);
  });
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  renderFileList();
}

async function uploadFiles() {
  if (selectedFiles.length === 0) {
    alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
    return;
  }
  
  if (!currentRepo) {
    alert('è¯·å…ˆé€‰æ‹©ä»“åº“');
    return;
  }
  
  const basePath = document.getElementById('uploadPath').value.trim();
  
  try {
    let successCount = 0;
    let errorCount = 0;
    
    // ä¸Šä¼ æ¯ä¸ªæ–‡ä»¶
    for (const file of selectedFiles) {
      try {
        const reader = new FileReader();
        
        await new Promise((resolve, reject) => {
          reader.onload = async function(e) {
            try {
              // è·å–æ–‡ä»¶å†…å®¹ï¼ˆbase64ï¼‰
              const content = e.target.result.split(',')[1]; // å»æ‰data:...å‰ç¼€
              
              // ç¡®å®šæ–‡ä»¶è·¯å¾„
              let filePath = file.name;
              if (basePath) {
                // å¦‚æœæŒ‡å®šäº†åŸºç¡€è·¯å¾„ï¼Œä½¿ç”¨åŸºç¡€è·¯å¾„+æ–‡ä»¶å
                filePath = basePath.endsWith('/') ? basePath + file.name : basePath + '/' + file.name;
              }
              
              // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
              const existingFile = await apiCall(`https://api.github.com/repos/${currentRepo}/contents/${filePath}`);
              let sha = null;
              if (existingFile && existingFile.sha) {
                sha = existingFile.sha;
              }
              
              // è°ƒç”¨GitHub APIä¸Šä¼ æ–‡ä»¶
              const result = await apiCall(
                `https://api.github.com/repos/${currentRepo}/contents/${filePath}`,
                'PUT',
                {
                  message: `Upload ${file.name}`,
                  content: content,
                  sha: sha // å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œéœ€è¦æä¾›shaæ¥æ›´æ–°
                }
              );
              
              if (result) {
                await log('upload-file', currentRepo, filePath, `ä¸Šä¼ æ–‡ä»¶: ${file.name} (${formatFileSize(file.size)})`);
                console.log(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`);
                successCount++;
              } else {
                console.error(`ä¸Šä¼ æ–‡ä»¶ ${file.name} å¤±è´¥`);
                errorCount++;
              }
              
              resolve();
            } catch (error) {
              console.error(`ä¸Šä¼ æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™:`, error);
              errorCount++;
              reject(error);
            }
          };
          
          reader.onerror = function() {
            console.error(`è¯»å–æ–‡ä»¶ ${file.name} å¤±è´¥`);
            errorCount++;
            reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'));
          };
          
          reader.readAsDataURL(file);
        });
      } catch (error) {
        console.error(`å¤„ç†æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™:`, error);
        errorCount++;
      }
    }
    
    let message = '';
    if (successCount > 0 && errorCount === 0) {
      message = `æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡ä»¶`;
    } else if (successCount > 0 && errorCount > 0) {
      message = `æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡ä»¶ï¼Œå¤±è´¥ ${errorCount} ä¸ªæ–‡ä»¶`;
    } else {
      message = `ä¸Šä¼ å¤±è´¥ï¼Œæ‰€æœ‰ ${errorCount} ä¸ªæ–‡ä»¶éƒ½æœªèƒ½ä¸Šä¼ `;
    }
    
    alert(message);
    hideUploadModal();
    
    // åˆ·æ–°ä»“åº“æ–‡ä»¶åˆ—è¡¨
    if (successCount > 0) {
      // é‡æ–°åŠ è½½å½“å‰ä»“åº“çš„æ–‡ä»¶åˆ—è¡¨
      const currentRepoElement = Array.from(document.querySelectorAll('.item.repo')).find(el => el.textContent === currentRepo);
      if (currentRepoElement) {
        // è·å–é»˜è®¤åˆ†æ”¯ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä¿å­˜åˆ†æ”¯ä¿¡æ¯ï¼‰
        const branch = 'main'; // é»˜è®¤åˆ†æ”¯ï¼Œå®é™…åº”è¯¥ä»ä»“åº“ä¿¡æ¯ä¸­è·å–
        await toggleRepo(currentRepo, branch);
      }
    }
  } catch (error) {
    console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
    alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ' + error.message);
  }
}

/* ====== APIè¯Šæ–­åŠŸèƒ½ ====== */
async function checkAllAPIs() {
  document.getElementById('apiModal').style.display = 'flex';
  
  // æ£€æŸ¥6ä¸ªæ—¶é—´API
  for (let i = 0; i < TIME_APIS.length; i++) {
    await checkTimeAPI(i+1, TIME_APIS[i]);
  }
  
  // æ£€æŸ¥GitHub API
  await checkGitHubAPI();
  
  // æ£€æŸ¥IndexedDB
  await checkIndexedDB();
  
  // æ£€æŸ¥ä»£ç é«˜äº®
  await checkCodeHighlight();
  
  // æ£€æŸ¥æ—¥å¿—æ˜¾ç¤º
  await checkLogDisplay();
  
  // æ£€æŸ¥æŒ‰é’®ç‚¹å‡»
  await checkButtonClick();
}

async function checkTimeAPI(index, url) {
  const element = document.getElementById(`timeAPI${index}`);
  element.className = 'api-status checking';
  element.innerHTML = '<span>â—Œ</span><span>æ—¶é—´API ' + index + '</span>';
  
  try {
    const res = await fetch(url);
    if (res.ok) {
      element.className = 'api-status success';
      element.innerHTML = '<span>â—‰</span><span>æ—¶é—´API ' + index + '</span>';
    } else {
      throw new Error('APIè¿”å›é”™è¯¯çŠ¶æ€');
    }
  } catch (e) {
    element.className = 'api-status failed';
    element.innerHTML = '<span>â¦¿</span><span>æ—¶é—´API ' + index + '</span>';
  }
}

async function checkGitHubAPI() {
  const element = document.getElementById('githubAPI');
  element.className = 'api-status checking';
  element.innerHTML = '<span>â—Œ</span><span>GitHub API</span>';
  
  try {
    const result = await apiCall('https://api.github.com/user');
    if (result && result.login) {
      element.className = 'api-status success';
      element.innerHTML = '<span>â—‰</span><span>GitHub API</span>';
    } else {
      throw new Error('GitHub APIè¿”å›æ— æ•ˆæ•°æ®');
    }
  } catch (e) {
    element.className = 'api-status failed';
    element.innerHTML = '<span>â¦¿</span><span>GitHub API</span>';
  }
}

async function checkIndexedDB() {
  const element = document.getElementById('indexedDB');
  element.className = 'api-status checking';
  element.innerHTML = '<span>â—Œ</span><span>IndexedDB</span>';
  
  try {
    const db = await openDB();
    if (db) {
      element.className = 'api-status success';
      element.innerHTML = '<span>â—‰</span><span>IndexedDB</span>';
    } else {
      throw new Error('IndexedDBæ‰“å¼€å¤±è´¥');
    }
  } catch (e) {
    element.className = 'api-status failed';
    element.innerHTML = '<span>â¦¿</span><span>IndexedDB</span>';
  }
}

async function checkCodeHighlight() {
  const element = document.getElementById('codeHighlight');
  element.className = 'api-status checking';
  element.innerHTML = '<span>â—Œ</span><span>ä»£ç é«˜äº®</span>';
  
  try {
    // æµ‹è¯•é«˜äº®åŠŸèƒ½
    const testCode = `
function hello() {
  console.log("Hello, World!");
  return 42;
}`;
    const highlighted = highlightCode(testCode, 'javascript');
    if (highlighted.includes('token keyword') && highlighted.includes('token string')) {
      element.className = 'api-status success';
      element.innerHTML = '<span>â—‰</span><span>ä»£ç é«˜äº®</span>';
    } else {
      throw new Error('ä»£ç é«˜äº®åŠŸèƒ½å¼‚å¸¸');
    }
  } catch (e) {
    element.className = 'api-status failed';
    element.innerHTML = '<span>â¦¿</span><span>ä»£ç é«˜äº®</span>';
  }
}

async function checkLogDisplay() {
  const element = document.getElementById('logDisplay');
  element.className = 'api-status checking';
  element.innerHTML = '<span>â—Œ</span><span>æ—¥å¿—æ˜¾ç¤º</span>';
  
  try {
    const logElement = document.getElementById('log');
    if (logElement) {
      element.className = 'api-status success';
      element.innerHTML = '<span>â—‰</span><span>æ—¥å¿—æ˜¾ç¤º</span>';
    } else {
      throw new Error('æ—¥å¿—æ˜¾ç¤ºå…ƒç´ ä¸å­˜åœ¨');
    }
  } catch (e) {
    element.className = 'api-status failed';
    element.innerHTML = '<span>â¦¿</span><span>æ—¥å¿—æ˜¾ç¤º</span>';
  }
}

async function checkButtonClick() {
  const element = document.getElementById('buttonClick');
  element.className = 'api-status checking';
  element.innerHTML = '<span>â—Œ</span><span>æŒ‰é’®ç‚¹å‡»</span>';
  
  try {
    // æµ‹è¯•æŒ‰é’®æ˜¯å¦å­˜åœ¨
    const buttons = document.querySelectorAll('button');
    if (buttons.length > 0) {
      element.className = 'api-status success';
      element.innerHTML = '<span>â—‰</span><span>æŒ‰é’®ç‚¹å‡»</span>';
    } else {
      throw new Error('æœªæ‰¾åˆ°ä»»ä½•æŒ‰é’®');
    }
  } catch (e) {
    element.className = 'api-status failed';
    element.innerHTML = '<span>â¦¿</span><span>æŒ‰é’®ç‚¹å‡»</span>';
  }
}

function hideApiModal() {
  document.getElementById('apiModal').style.display = 'none';
}

/* ====== å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½ ====== */
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + text);
  }).catch(err => {
    console.error('å¤åˆ¶å¤±è´¥: ', err);
    // å¤‡ç”¨æ–¹æ³•
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿: ' + text);
  });
}

/* ====== å…¶ä»–åŠŸèƒ½å‡½æ•° ====== */
function toggleEdit(){
  const editor = document.getElementById('editor');
  const viewPre = document.getElementById('viewPre');
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  
  if(editor.style.display === 'none'){
    editor.style.display = 'block';
    viewPre.style.display = 'none';
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline';
    document.getElementById('deployBtn').style.display = 'none';
    log('toggle-edit', selected.repo, selected.path, 'è¿›å…¥ç¼–è¾‘æ¨¡å¼');
  } else {
    editor.style.display = 'none';
    viewPre.style.display = 'block';
    editBtn.style.display = 'inline';
    saveBtn.style.display = 'none';
    document.getElementById('deployBtn').style.display = 'inline';
    log('toggle-edit', selected.repo, selected.path, 'é€€å‡ºç¼–è¾‘æ¨¡å¼');
  }
}

async function saveFile(){
  if(!selected.repo || !selected.path) return alert('æœªé€‰æ‹©æ–‡ä»¶');
  const content = document.getElementById('editor').value;
  const result = await apiCall(
    `https://api.github.com/repos/${selected.repo}/contents/${selected.path}`,
    'PUT',
    {
      message: `Update ${selected.path}`,
      content: b64e(content),
      sha: selected.sha
    }
  );
  if(result){
    await dbPut(STORE.cache, selected.repo + selected.path, {content, updatedAt: Date.now()});
    selected.sha = result.content.sha;
    await log('update-file', selected.repo, selected.path, `æ›´æ–°æ–‡ä»¶å†…å®¹`);
    toggleEdit();
    alert('ä¿å­˜æˆåŠŸ');
  }
}

async function downloadFile(){
  if(!selected.downloadUrl) return alert('æœªé€‰æ‹©æ–‡ä»¶');
  const content = document.getElementById('editor').value;
  const blob = new Blob([content], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = selected.path.split('/').pop();
  a.click();
  URL.revokeObjectURL(url);
  await log('download-file', selected.repo, selected.path, `ä¸‹è½½æ–‡ä»¶`);
}

async function deleteFile(){
  if(!selected.repo || !selected.path || !selected.sha) return alert('æœªé€‰æ‹©æ–‡ä»¶');
  if(!confirm(`ç¡®å®šåˆ é™¤ ${selected.path}?`)) return;
  const result = await apiCall(
    `https://api.github.com/repos/${selected.repo}/contents/${selected.path}`,
    'DELETE',
    {message: `Delete ${selected.path}`, sha: selected.sha}
  );
  if(result){
    await dbDel(STORE.cache, selected.repo + selected.path);
    await log('delete-file', selected.repo, selected.path, `åˆ é™¤æ–‡ä»¶`);
    alert('åˆ é™¤æˆåŠŸ');
    location.reload();
  }
}

async function createRepo(){
  const name = prompt('è¾“å…¥ä»“åº“å');
  if(!name) return;
  const result = await apiCall('https://api.github.com/user/repos', 'POST', {name, auto_init: true});
  if(result){
    await log('create-repo', result.full_name, '', `åˆ›å»ºä»“åº“: ${name}`);
    await loadRepoList();
    alert('åˆ›å»ºæˆåŠŸ');
  }
}

async function deleteRepo(){
  if(!currentRepo) return alert('è¯·å…ˆé€‰æ‹©ä»“åº“');
  if(!confirm(`ç¡®å®šåˆ é™¤ ${currentRepo}?`)) return;
  const result = await apiCall(`https://api.github.com/repos/${currentRepo}`, 'DELETE');
  if(result){
    await log('delete-repo', currentRepo, '', `åˆ é™¤ä»“åº“`);
    await loadRepoList();
    alert('åˆ é™¤æˆåŠŸ');
  }
}

/* ====== æ˜¾ç¤ºéƒ¨ç½²ç»“æœ ====== */
function showDeployResult(message, isSuccess = true, siteUrl = null) {
  const deployResult = document.getElementById('deployResult');
  
  if (siteUrl) {
    deployResult.innerHTML = `
      <div style="color:${isSuccess ? 'var(--green)' : 'var(--red)'}; margin-bottom:15px;">${message}</div>
      <div class="deploy-url">
        <input type="text" id="siteUrl" value="${siteUrl}" readonly>
        <button onclick="copyToClipboard('${siteUrl}')">å¤åˆ¶åœ°å€</button>
      </div>
      <div style="margin-top:10px;font-size:14px;color:rgba(255,255,255,0.7)">
        ç½‘ç«™åœ°å€å·²ç”Ÿæˆï¼Œç‚¹å‡»"å¤åˆ¶åœ°å€"æŒ‰é’®å¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚
      </div>
    `;
  } else {
    deployResult.innerHTML = `<div style="color:${isSuccess ? 'var(--green)' : 'var(--red)'}">${message}</div>`;
  }
  
  deployResult.style.display = 'block';
  
  // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
  if (currentDeployTimeout) {
    clearTimeout(currentDeployTimeout);
  }
  
  // è®¾ç½®11ç§’åéšè—
  currentDeployTimeout = setTimeout(() => {
    deployResult.style.display = 'none';
  }, 11000);
}

async function deployRepo() {
  if (!currentRepo) return alert('è¯·å…ˆé€‰æ‹©ä»“åº“');
  
  showDeployResult('æ­£åœ¨éƒ¨ç½²ä»“åº“ ' + currentRepo + '...', true);
  
  try {
    // æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // æ„å»ºç½‘ç«™åœ°å€
    const repoName = currentRepo.split('/')[1];
    const siteUrl = `https://${currentUser ? currentUser.login : 'username'}.github.io/${repoName}`;
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²é€»è¾‘
    // ä¾‹å¦‚é€šè¿‡GitHub Pages APIéƒ¨ç½²
    const result = await apiCall(
      `https://api.github.com/repos/${currentRepo}/pages`,
      'POST',
      {
        source: {
          branch: "main",
          path: "/"
        }
      }
    );
    
    if (result) {
      deployedRepos.add(currentRepo);
      showDeployResult(`éƒ¨ç½²æˆåŠŸï¼ä»“åº“ ${currentRepo} å·²éƒ¨ç½²ã€‚`, true, siteUrl);
      await log('deploy-repo', currentRepo, '', `éƒ¨ç½²æˆåŠŸ: ${siteUrl}`);
      
      // æ›´æ–°éƒ¨ç½²æŒ‰é’®çŠ¶æ€
      await updateDeployButton(currentRepo);
    } else {
      showDeployResult('éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“è®¾ç½®ã€‚', false);
      await log('deploy-repo', currentRepo, '', 'éƒ¨ç½²ä»“åº“å¤±è´¥');
    }
  } catch (e) {
    console.error('éƒ¨ç½²å¤±è´¥:', e);
    showDeployResult('éƒ¨ç½²å¤±è´¥: ' + e.message, false);
    await log('deploy-repo', currentRepo, '', 'éƒ¨ç½²ä»“åº“å¤±è´¥: ' + e.message);
  }
}

async function undeployRepo(repo) {
  if (!repo) return alert('è¯·å…ˆé€‰æ‹©ä»“åº“');
  
  if (!confirm(`ç¡®å®šè¦å–æ¶ˆéƒ¨ç½² ${repo} å—ï¼Ÿ`)) return;
  
  showDeployResult('æ­£åœ¨å–æ¶ˆéƒ¨ç½²ä»“åº“ ' + repo + '...', true);
  
  try {
    // æ¨¡æ‹Ÿå–æ¶ˆéƒ¨ç½²è¿‡ç¨‹
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„å–æ¶ˆéƒ¨ç½²é€»è¾‘
    // ä¾‹å¦‚é€šè¿‡GitHub Pages APIåˆ é™¤éƒ¨ç½²
    const result = await apiCall(
      `https://api.github.com/repos/${repo}/pages`,
      'DELETE'
    );
    
    if (result !== null) { // DELETEè¯·æ±‚æˆåŠŸè¿”å›204ï¼Œæ²¡æœ‰å†…å®¹
      deployedRepos.delete(repo);
      showDeployResult(`å–æ¶ˆéƒ¨ç½²æˆåŠŸï¼ä»“åº“ ${repo} å·²å–æ¶ˆéƒ¨ç½²ã€‚`, true);
      await log('undeploy-repo', repo, '', 'å–æ¶ˆéƒ¨ç½²æˆåŠŸ');
      
      // æ›´æ–°éƒ¨ç½²æŒ‰é’®çŠ¶æ€
      await updateDeployButton(repo);
    } else {
      showDeployResult('å–æ¶ˆéƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“è®¾ç½®ã€‚', false);
      await log('undeploy-repo', repo, '', 'å–æ¶ˆéƒ¨ç½²å¤±è´¥');
    }
  } catch (e) {
    console.error('å–æ¶ˆéƒ¨ç½²å¤±è´¥:', e);
    showDeployResult('å–æ¶ˆéƒ¨ç½²å¤±è´¥: ' + e.message, false);
    await log('undeploy-repo', repo, '', 'å–æ¶ˆéƒ¨ç½²å¤±è´¥: ' + e.message);
  }
}

/* ====== åˆå§‹åŒ– ====== */
window.onload = async () => {
  try {
    // åˆå§‹åŒ–æ•°æ®åº“
    await openDB();
    
    // æ£€æŸ¥å¯†é’¥
    const hasSecret = await checkSecret();
    
    // åŠ è½½ä»“åº“åˆ—è¡¨
    await loadRepoList();
    
    // æ¸²æŸ“æ—¥å¿—
    await renderLog();
    
    // æ¸²æŸ“å¯†é’¥åˆ—è¡¨
    await renderSecretList();
    
    // ç¡®ä¿æ—¶é—´æ˜¾ç¤ºæ­£å¸¸
    await updateClock();
    
    console.log('åˆå§‹åŒ–å®Œæˆ');
  } catch(e) {
    console.error('åˆå§‹åŒ–å¤±è´¥:', e);
    
    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
    document.getElementById('tree').innerHTML = '<div style="text-align:center;padding:20px;color:var(--red)">åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
  }
};
</script>
</body>
</html>